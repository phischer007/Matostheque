(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[174],{61405:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/create/create-loan",function(){return a(81006)}])},81006:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return H}});var l=a(85893),r=a(67294),n=a(9008),o=a.n(n),i=a(5616),s=a(65582),u=a(51233),c=a(15861),d=a(27400),h=a(356),m=a(66242),f=a(78445),x=a(44267),p=a(73024),_=a(21177),j=a(46901),y=a(67720),w=a(62023),Z=a(69417),b=a(39348),v=a(50720),g=a(11163),D=a(39332),S=a(64352),C=a(77349),M=a(13882),k=a(83946),E=a(3151),O=a(24257),N=a(30381),T=a.n(N),L=a(99565),Y=a(71501);let q=e=>{let t=(0,D.useRouter)(),a=(0,L.a)().user,l=e.materialsList?Object.values(e.materialsList):null,[n,o]=(0,r.useState)(new Date),[i,s]=(0,r.useState)(new Date),[u,c]=(0,r.useState)(null),[d,h]=(0,r.useState)(null),[m,f]=(0,r.useState)(null),{addNotification:x}=(0,Y.l)(),[p,_]=(0,r.useState)({material:!1,startDate:!1,endDate:!1,location:!1}),[j,y]=(0,r.useState)({material:null,loan_date:n||null,duration:null,borrower:a?a.user_id:null,location:null}),[w,Z]=(0,r.useState)({status:null,value:""}),b=(0,r.useCallback)(e=>{if(u)for(let t in u){let a=u[t];if("Borrowed"==a.loan_status||"Overdue"==a.loan_status||"Booked"==a.loan_status){let t=new Date(a.loan_date),l=(0,C.Z)(t,a.duration-1);if((0,E.Z)(e,t)||(0,O.Z)(e,{start:t,end:l}))return!0}}return!1},[u]),v=(0,r.useCallback)(e=>{y(t=>({...t,[e.target.name]:e.target.value}))},[]),g=(0,r.useCallback)((e,t)=>{t&&(h(t),y(e=>({...e,material:t.material_id})),f(t.loan_duration),Z({status:"info",value:"You can borrow the material up to ".concat(t.loan_duration," days.")}),fetch("".concat(S.Z.apiUrl,"/material/").concat(t.material_id,"/events/lite/")).then(e=>e.json()).then(e=>{e&&c(e)}).catch(e=>console.error("Error fetching data:",e)))},[]),N=(0,r.useCallback)(()=>{let e=n.setHours(0,0,0,0);return Math.floor((i.setHours(0,0,0,0)-e)/864e5)+1},[n,i]),q=(0,r.useCallback)(e=>{let{owner_user_id:t,borrower_id:a,borrower_name:l,material_title:r,validation:n,loan:o}=e,i=n?"Your request to borrow: ".concat(r," is waiting for approval."):"You successfully booked the material: ".concat(r,"."),s=n?"You have a new pending request: ".concat(r):" ".concat(l," has booked your material: ").concat(r,".");t!==a?(x({message:s,notificationType:n?"Request Alert":"Event",user:t,priority:n?"High":"Medium",title:"New Request",loan:o}),x({message:i,notificationType:"General",user:a,priority:n?"Medium":"Low",title:"New Request",loan:o})):x({message:"You have reserved your material: ".concat(r),notificationType:"General",priority:"Low",title:"Material Reservation",user:t,loan:o})},[x]),P=(0,r.useCallback)(async e=>{e.preventDefault();let l=T()(j.loan_date,"YYYY-MM-DDTHH:mm:ss.SSS[Z]");j.loan_date=l;let r={material:null===j.material,startDate:null===j.loan_date,endDate:null===i,location:null===j.location};if(_(r),a.user_id==d.owner__user_id&&(j.approval_date=new Date().toISOString()),!Object.values(r).some(e=>e))try{let e=await fetch("".concat(S.Z.apiUrl,"/loans/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(j)});if(e.ok){let l=await e.json();q({material_title:d.material_title,borrower_id:a.user_id,borrower_name:a.first_name+" "+a.last_name,owner_user_id:d.owner__user_id,validation:d.validation,loan:l.loan_id}),setTimeout(()=>{t.push("/myloans")},2e3)}else{let t=await e.text(),a=JSON.parse(t),[l]=Object.keys(a);Z({status:"error",value:"".concat(l," : ").concat(a[l])}),console.log(a[l])}}catch(e){Z({status:"error",value:"Could not borrow. Please verify yor data or try ulteriorly"})}},[j,t]);return(0,r.useEffect)(()=>{if(n&&i){let e=N();y(t=>({...t,duration:e}))}},[n,i]),(0,r.useEffect)(()=>{if(e.selectedMaterial){let t=l.find(t=>t.material_id===e.selectedMaterial);h(t),y(t=>({...t,material:e.selectedMaterial})),f(t.loan_duration),fetch("".concat(S.Z.apiUrl,"/material/").concat(t.material_id,"/events/lite/")).then(e=>e.json()).then(e=>{e&&c(e)}).catch(e=>console.error("Error fetching data:",e)),Z({status:"info",value:"You can borrow the material up to ".concat(t.loan_duration," days.")})}},[e.selectedMaterial]),{materialsArray:l,startDate:n,endDate:i,formData:j,message:w,handleStartDateChange:e=>{o(e),(!i||e>i)&&s(e),y(t=>({...t,loan_date:e}))},handleEndDateChange:e=>{s(e)},isDateStartDisabled:e=>e<function(e,t){(0,M.Z)(2,arguments);var a=(0,k.Z)(1);return(0,C.Z)(e,-a)}(new Date,1)||b(e),isDateEndDisabled:e=>!!d&&!!n&&(!!(e<n+1||e>(0,C.Z)(n,m-1))||b(e)),handleChange:v,onSelectChange:g,handleSubmit:P,selectedMaterial:d,formErrors:p}};var P=a(2734),R=(0,g.withRouter)(e=>{let t=(0,P.Z)(),{materialsArray:a,startDate:r,endDate:n,message:o,handleStartDateChange:s,handleEndDateChange:u,isDateStartDisabled:c,isDateEndDisabled:h,handleChange:g,onSelectChange:D,handleSubmit:S,selectedMaterial:C,formErrors:M}=q(e);return(0,l.jsx)("form",{autoComplete:"off",noValidate:!0,onSubmit:S,children:(0,l.jsxs)(m.Z,{children:[(0,l.jsx)(f.Z,{subheader:"Fill the information to submit your loan",title:"Loan Information"}),(0,l.jsx)(x.Z,{sx:{pt:0},children:(0,l.jsx)(i.Z,{sx:{m:-1.5},children:(0,l.jsxs)(d.Z,{container:!0,spacing:3,children:[(0,l.jsx)(d.Z,{xs:12,md:6,children:a?(0,l.jsx)(p.Z,{fullWidth:!0,required:!0,options:a,getOptionLabel:e=>e.material_title,value:C||null,onChange:D,renderInput:e=>(0,l.jsx)(_.Z,{...e,variant:"standard",label:"Materials",placeholder:"Select a material",margin:"normal",fullWidth:!0,error:M.material,helperText:M.material&&"Please select a material"})}):null}),(0,l.jsx)(d.Z,{xs:12,sm:6,children:(0,l.jsx)(v._,{children:(0,l.jsx)(b.M,{label:"Start Date",value:r,onChange:s,shouldDisableDate:c,fullWidth:!0,format:"dd/MM/yyyy"})})}),(0,l.jsx)(d.Z,{xs:12,sm:6,children:(0,l.jsx)(v._,{children:(0,l.jsx)(b.M,{label:"End Date",value:n,onChange:u,disablePast:!0,minDate:r||new Date,shouldDisableDate:h,fullWidth:!0,format:"dd/MM/yyyy"})})}),(0,l.jsx)(d.Z,{xs:12,md:6,children:(0,l.jsx)(_.Z,{fullWidth:!0,label:"Location",name:"location",error:M.location,helperText:M.location&&"Please select a location",onChange:g,type:"text",required:!0,placeholder:"Ex. Room 203",InputLabelProps:{shrink:!0},sx:{input:{"&::placeholder":{opacity:1,color:t.palette.text.secondary}}}})}),(0,l.jsx)(d.Z,{xs:12,md:6,children:(0,l.jsx)(_.Z,{fullWidth:!0,label:"Note to Owner",name:"message",onChange:g,type:"text",multiline:!0,rows:4,placeholder:"Write your message to the owner here..."})}),o&&o.status?(0,l.jsx)(d.Z,{xs:12,md:6,children:(0,l.jsxs)(j.Z,{severity:o.status,children:[" ",o.value]})}):null]})})}),(0,l.jsx)(y.Z,{}),(0,l.jsx)(w.Z,{sx:{justifyContent:"flex-end"},children:(0,l.jsx)(Z.Z,{type:"submit",variant:"contained",children:"Borrow"})})]})})});let W=()=>{let{materialId:e}=(0,g.useRouter)().query,[t,a]=(0,r.useState)(null);return(0,r.useEffect)(()=>{fetch("".concat(S.Z.apiUrl,"/materials/lite/")).then(e=>e.json()).then(e=>{a(e)}).catch(e=>console.error("Error fetching data:",e))},[]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o(),{children:(0,l.jsx)("title",{children:"New loan"})}),(0,l.jsx)(i.Z,{component:"main",sx:{flexGrow:1,py:8},children:(0,l.jsx)(s.Z,{maxWidth:"lg",children:(0,l.jsxs)(u.Z,{spacing:3,children:[(0,l.jsx)("div",{children:(0,l.jsx)(c.Z,{variant:"h4",children:"Borrow a material"})}),(0,l.jsx)("div",{children:(0,l.jsx)(d.Z,{container:!0,spacing:3,children:(0,l.jsx)(d.Z,{xs:12,md:10,lg:10,children:t&&(0,l.jsx)(R,{materialsList:t,selectedMaterial:e?parseInt(e):null})})})})]})})})]})};W.getLayout=e=>(0,l.jsx)(h.A,{children:e});var H=W}},function(e){e.O(0,[885,839,294,589,740,360,54,911,348,214,356,774,888,179],function(){return e(e.s=61405)}),_N_E=e.O()}]);